'use client';

import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from '@/components/ui/table';
import { 
  FileText, 
  Info, 
  Clock, 
  Edit3, 
  CheckSquare,
  Building,
  Calendar,
  User,
  Loader2,
  Plus,
  Download,
  ExternalLink
} from 'lucide-react';
import { useMutation, useQuery, gql } from '@apollo/client';
import { useRouter } from 'next/navigation';

const UPDATE_MYBID = gql`
  mutation UpdateMyBid($input: MyBidUpdateInput!) {
    mybidUpdate(input: $input) {
      success
      message
      nid
      status
    }
  }
`;

const GET_NOTICE_FILES = gql`
  query GetNoticeFiles($nid: Int!) {
    noticeFiles(nid: $nid) {
      success
      nid
      files {
        file_name
        file_url
        down_folder
        source
        order
      }
      total_count
    }
  }
`;

const GET_NOTICE_DETAILS = gql`
  query GetNoticeDetails($nid: Int!) {
    noticeDetails(nid: $nid) {
      success
      nid
      details {
        title
        notice_num
        org_dept
        org_tel
        body_html
        detail_url
        category
      }
      message
    }
  }
`;

const UPDATE_NOTICE_DETAILS = gql`
  mutation UpdateNoticeDetails($nid: Int!, $input: NoticeDetailsInput!) {
    noticeDetailsUpdate(nid: $nid, input: $input) {
      success
      message
      nid
    }
  }
`;

interface Bid {
  mid: number;
  nid: number;
  title: string;
  status: string;
  startedAt?: string;
  endedAt?: string;
  memo?: string;
  orgName: string;
  postedAt: string;
  detail?: string;
  category?: string;
  region?: string;
}

interface BidDetailViewProps {
  bid: Bid;
}

export default function BidDetailView({ bid }: BidDetailViewProps) {
  const router = useRouter();
  const [updateMyBid, { loading }] = useMutation(UPDATE_MYBID);
  const { data: noticeFilesData, loading: filesLoading, refetch: refetchFiles } = useQuery(GET_NOTICE_FILES, {
    variables: { nid: bid.nid },
    errorPolicy: 'all'
  });
  
  const { data: noticeDetailsData, loading: detailsLoading, refetch: refetchDetails } = useQuery(GET_NOTICE_DETAILS, {
    variables: { nid: bid.nid },
    errorPolicy: 'all'
  });
  
  const [updateNoticeDetails, { loading: updatingDetails }] = useMutation(UPDATE_NOTICE_DETAILS);
  
  const [selectedStatus, setSelectedStatus] = useState('');
  const [memo, setMemo] = useState('');
  const [dynamicFields, setDynamicFields] = useState<Record<string, any>>({});
  const [noticeFields, setNoticeFields] = useState<Record<string, any>>({});
  const [isEditingNotice, setIsEditingNotice] = useState(false);
  const [isEditingFiles, setIsEditingFiles] = useState(false);
  const [selectedDownloads, setSelectedDownloads] = useState<Set<string>>(new Set());
  const [isEditingNoticeDetails, setIsEditingNoticeDetails] = useState(false);
  const [noticeDetailsFields, setNoticeDetailsFields] = useState<Record<string, any>>({});
  const [progressMemo, setProgressMemo] = useState('');

  // ÌååÏùº Î∑∞Ïñ¥ Ìï®Ïàò
  const openFileViewer = (fileName: string, fileUrl: string) => {
    const fileExt = fileName.split('.').pop()?.toLowerCase();
    
    if (!fileUrl) {
      alert('ÌååÏùº URLÏù¥ ÏóÜÏäµÎãàÎã§.');
      return;
    }

    // ÌååÏùº ÌôïÏû•ÏûêÏóê Îî∞Î•∏ Ï≤òÎ¶¨
    switch (fileExt) {
      case 'pdf':
        // PDF Î∑∞Ïñ¥ - Google Docs Viewer ÏÇ¨Ïö©ÌïòÏó¨ Îã§Ïö¥Î°úÎìú Î∞©ÏßÄ
        const pdfViewerContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>PDF Viewer - ${fileName}</title>
            <meta charset="utf-8">
            <style>
              body { 
                margin: 0; 
                padding: 0; 
                font-family: Arial, sans-serif;
              }
              .header {
                background: #f8f9fa;
                padding: 10px 20px;
                border-bottom: 1px solid #dee2e6;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              .title {
                font-weight: bold;
                color: #495057;
              }
              .download-btn {
                background: #007bff;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                text-decoration: none;
                font-size: 14px;
              }
              .download-btn:hover {
                background: #0056b3;
              }
              .pdf-container {
                width: 100%;
                height: calc(100vh - 60px);
              }
              .pdf-frame {
                width: 100%;
                height: 100%;
                border: none;
              }
              .loading {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100%;
                color: #666;
              }
            </style>
          </head>
          <body>
            <div class="header">
              <div class="title">üìÑ ${fileName}</div>
              <a href="${fileUrl}" target="_blank" class="download-btn">Îã§Ïö¥Î°úÎìú</a>
            </div>
            <div class="pdf-container">
              <div class="loading">PDFÎ•º Î°úÎìúÌïòÎäî Ï§ë...</div>
              <iframe 
                src="https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true" 
                class="pdf-frame"
                onload="document.querySelector('.loading').style.display='none'; this.style.display='block'"
                style="display: none;">
              </iframe>
            </div>
          </body>
          </html>
        `;
        const pdfBlob = new Blob([pdfViewerContent], { type: 'text/html' });
        const pdfUrl = URL.createObjectURL(pdfBlob);
        window.open(pdfUrl, '_blank');
        break;
      
      case 'xlsx':
      case 'xls':
        // Excel ÌååÏùº - Google Docs Viewer ÏÇ¨Ïö©
        const excelViewerContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Excel Viewer - ${fileName}</title>
            <meta charset="utf-8">
            <style>
              body { 
                margin: 0; 
                padding: 0; 
                font-family: Arial, sans-serif;
              }
              .header {
                background: #f8f9fa;
                padding: 10px 20px;
                border-bottom: 1px solid #dee2e6;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              .title {
                font-weight: bold;
                color: #495057;
              }
              .download-btn {
                background: #28a745;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                text-decoration: none;
                font-size: 14px;
              }
              .download-btn:hover {
                background: #1e7e34;
              }
              .excel-container {
                width: 100%;
                height: calc(100vh - 60px);
              }
              .excel-frame {
                width: 100%;
                height: 100%;
                border: none;
              }
            </style>
          </head>
          <body>
            <div class="header">
              <div class="title">üìä ${fileName}</div>
              <a href="${fileUrl}" target="_blank" class="download-btn">Îã§Ïö¥Î°úÎìú</a>
            </div>
            <div class="excel-container">
              <iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true" class="excel-frame"></iframe>
            </div>
          </body>
          </html>
        `;
        const excelBlob = new Blob([excelViewerContent], { type: 'text/html' });
        const excelUrl = URL.createObjectURL(excelBlob);
        window.open(excelUrl, '_blank');
        break;
      
      case 'hwp':
      case 'hwpx':
        // HWP ÌååÏùº - Íµ¨ÌòÑ Ï§ë Î©îÏãúÏßÄ
        const hwpViewerContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>HWP Viewer</title>
            <meta charset="utf-8">
            <style>
              body { 
                font-family: Arial, sans-serif; 
                display: flex; 
                justify-content: center; 
                align-items: center; 
                height: 100vh; 
                margin: 0; 
                background-color: #f5f5f5;
              }
              .message { 
                text-align: center; 
                padding: 40px; 
                background: white; 
                border-radius: 8px; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
              }
              .file-name { 
                color: #666; 
                margin-top: 10px; 
                font-size: 14px; 
              }
            </style>
          </head>
          <body>
            <div class="message">
              <h2>üìÑ HWPX Viewer</h2>
              <p>hwpx viewerÎäî Íµ¨ÌòÑÏ§ëÏûÖÎãàÎã§</p>
              <div class="file-name">${fileName}</div>
            </div>
          </body>
          </html>
        `;
        const hwpBlob = new Blob([hwpViewerContent], { type: 'text/html' });
        const hwpUrl = URL.createObjectURL(hwpBlob);
        window.open(hwpUrl, '_blank');
        break;
      
      case 'doc':
      case 'docx':
        // Word ÌååÏùº - Google Docs Viewer ÏÇ¨Ïö©
        const wordViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true`;
        window.open(wordViewerUrl, '_blank');
        break;
      
      case 'ppt':
      case 'pptx':
        // PowerPoint ÌååÏùº - Google Docs Viewer ÏÇ¨Ïö©
        const pptViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true`;
        window.open(pptViewerUrl, '_blank');
        break;
      
      default:
        // Í∏∞ÌÉÄ ÌååÏùº - Í∏∞Î≥∏ Î∏åÎùºÏö∞Ï†Ä Ï≤òÎ¶¨
        window.open(fileUrl, '_blank');
        break;
    }
  };

  // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÌååÏã±
  const parseDetailData = () => {
    try {
      return bid.detail ? JSON.parse(bid.detail) : {};
    } catch (e) {
      console.error('Failed to parse detail:', e);
      return {};
    }
  };

  const parseMemoData = () => {
    try {
      return bid.memo ? JSON.parse(bid.memo) : {};
    } catch (e) {
      console.error('Failed to parse memo:', e);
      return {};
    }
  };

  const detailData = parseDetailData();
  const memoData = parseMemoData();

  // ÏßÑÌñâ Î©îÎ™® ÌÖçÏä§Ìä∏Îßå Ï∂îÏ∂úÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
  const extractProgressMemo = () => {
    let progressMemoData = memoData['ÏßÑÌñâ'] || '';
    
    // ÎßåÏïΩ progressMemoDataÍ∞Ä JSON Í∞ùÏ≤¥ÎùºÎ©¥ ÌÖçÏä§Ìä∏Îßå Ï∂îÏ∂ú
    if (typeof progressMemoData === 'object') {
      progressMemoData = progressMemoData['ÏßÑÌñâ'] || '';
    }
    
    // ÎßåÏïΩ JSON Î¨∏ÏûêÏó¥Ïù¥ÎùºÎ©¥ ÌååÏã±Ìï¥ÏÑú ÌÖçÏä§Ìä∏Îßå Ï∂îÏ∂ú
    if (typeof progressMemoData === 'string' && progressMemoData.startsWith('{')) {
      try {
        const parsed = JSON.parse(progressMemoData);
        progressMemoData = parsed['ÏßÑÌñâ'] || progressMemoData;
      } catch (e) {
        // JSON ÌååÏã± Ïã§Ìå®Ïãú ÏõêÎ≥∏ Î¨∏ÏûêÏó¥ ÏÇ¨Ïö©
        console.log('Failed to parse memo as JSON, using as text:', progressMemoData);
      }
    }
    
    return progressMemoData;
  };

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú ÏûÖÏ∞∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  React.useEffect(() => {
    const bidDetail = detailData['ÏûÖÏ∞∞'] || {};
    setNoticeFields(bidDetail);
  }, []);

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú ÏßÑÌñâ Î©îÎ™® Î°úÎìú
  React.useEffect(() => {
    setProgressMemo(extractProgressMemo());
  }, []);

  // ÌååÏùº Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÎ©¥ Îã§Ïö¥Î°úÎìú Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî
  React.useEffect(() => {
    if (noticeFilesData?.noticeFiles?.files) {
      const newSelectedDownloads = new Set<string>();
      noticeFilesData.noticeFiles.files.forEach((file: any) => {
        // down_folderÏóê ÎÇ¥Ïö©Ïù¥ ÏóÜÎäî Í≤ΩÏö∞: Ï≤¥ÌÅ¨Îê®, ÏûàÎäî Í≤ΩÏö∞: Ï≤¥ÌÅ¨ ÏïàÎê®
        if (!file.down_folder || file.down_folder.trim() === '') {
          newSelectedDownloads.add(file.file_name);
        }
      });
      setSelectedDownloads(newSelectedDownloads);
    }
  }, [noticeFilesData]);

  // Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÎ©¥ ÌïÑÎìú Ï¥àÍ∏∞Ìôî
  React.useEffect(() => {
    if (noticeDetailsData?.noticeDetails?.details) {
      setNoticeDetailsFields(noticeDetailsData.noticeDetails.details);
    }
  }, [noticeDetailsData]);

  // ÏÑ†ÌÉùÎêú ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎê† Îïå Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î°ú Ìèº ÌïÑÎìú Ï¥àÍ∏∞Ìôî
  const loadStatusData = (status: string) => {
    const statusDetail = detailData[status] || {};
    const statusMemo = memoData[status] || '';
    
    setMemo(statusMemo);
    setDynamicFields(statusDetail);
  };

  // ÎèôÏ†Å ÌïÑÎìú Í∞í ÏóÖÎç∞Ïù¥Ìä∏
  const updateDynamicField = (key: string, value: any) => {
    setDynamicFields(prev => ({ ...prev, [key]: value }));
  };

  // Í≥µÍ≥† ÌïÑÎìú Í∞í ÏóÖÎç∞Ïù¥Ìä∏
  const updateNoticeField = (key: string, value: any) => {
    setNoticeFields(prev => ({ ...prev, [key]: value }));
  };

  // ÏûÖÏ∞∞ Ï†ïÎ≥¥ Ï†ÄÏû•
  const saveNoticeFields = async () => {
    try {
      // Îëê Î≤àÏùò API Ìò∏Ï∂úÎ°ú Î∂ÑÎ¶¨: Î®ºÏ†Ä ÏûÖÏ∞∞ detail Ï†ÄÏû•, Í∑∏Îã§Ïùå ÏßÑÌñâ memo Ï†ÄÏû•
      
      // 1. ÏûÖÏ∞∞ ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû• (detail ÌïÑÎìúÎ•º 'ÏûÖÏ∞∞' ÏÉÅÌÉúÎ°ú Ï†ÄÏû•)
      const { data: detailResult } = await updateMyBid({
        variables: {
          input: {
            nid: bid.nid,
            status: 'ÏûÖÏ∞∞', // detailÏùÑ 'ÏûÖÏ∞∞' ÏÉÅÌÉúÎ°ú Ï†ÄÏû•
            memo: null,
            detail: JSON.stringify(noticeFields) // noticeFields ÏûêÏ≤¥Î•º Ï†ÄÏû•
          }
        }
      });

      if (!detailResult?.mybidUpdate?.success) {
        throw new Error(detailResult?.mybidUpdate?.message || 'ÏûÖÏ∞∞ Ï†ïÎ≥¥ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }

      // 2. ÏßÑÌñâ Î©îÎ™® Ï†ÄÏû• (memo ÌïÑÎìúÎ•º 'ÏßÑÌñâ' ÏÉÅÌÉúÎ°ú Ï†ÄÏû•)
      const { data: memoResult } = await updateMyBid({
        variables: {
          input: {
            nid: bid.nid,
            status: 'ÏßÑÌñâ', // memoÎ•º 'ÏßÑÌñâ' ÏÉÅÌÉúÎ°ú Ï†ÄÏû•
            memo: progressMemo,
            detail: null
          }
        }
      });

      if (!memoResult?.mybidUpdate?.success) {
        throw new Error(memoResult?.mybidUpdate?.message || 'Î©îÎ™® Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }

      setIsEditingNotice(false);
      router.refresh();
    } catch (error) {
      console.error('ÏûÖÏ∞∞ Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
      alert('ÏûÖÏ∞∞ Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  // Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏
  const updateNoticeDetailsField = (key: string, value: any) => {
    setNoticeDetailsFields(prev => ({ ...prev, [key]: value }));
  };

  // Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû•
  const saveNoticeDetailsFields = async () => {
    try {
      // __typename ÌïÑÎìú Ï†úÍ±∞ Î∞è null Í∞í Ï≤òÎ¶¨
      const cleanInput = Object.keys(noticeDetailsFields).reduce((acc, key) => {
        if (key !== '__typename') {
          acc[key] = noticeDetailsFields[key] || '';
        }
        return acc;
      }, {} as any);

      const { data } = await updateNoticeDetails({
        variables: {
          nid: bid.nid,
          input: cleanInput
        }
      });

      if (data?.noticeDetailsUpdate?.success) {
        setIsEditingNoticeDetails(false);
        refetchDetails();
        alert('Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.');
      } else {
        throw new Error(data?.noticeDetailsUpdate?.message || 'Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
      alert('Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  const statusOptions = [
    { value: 'ÏùëÏ∞∞', label: 'ÏùëÏ∞∞' },
    { value: 'ÎÇôÏ∞∞', label: 'ÎÇôÏ∞∞' },
    { value: 'Ìå®Ï∞∞', label: 'Ìå®Ï∞∞' },
    { value: 'Ìè¨Í∏∞', label: 'Ìè¨Í∏∞' }
  ];

  const renderDynamicFields = () => {
    if (!selectedStatus) return null;

    // ÌòÑÏû¨ ÏÉÅÌÉúÏóê ÎåÄÌïú detail Îç∞Ïù¥ÌÑ∞
    const statusDetail = detailData[selectedStatus] || {};
    
    return (
      <div className="grid gap-4 mt-4 p-4 bg-gray-50 rounded-lg">
        {/* ÎèôÏ†ÅÏúºÎ°ú detail ÌïÑÎìúÎì§ ÏÉùÏÑ± */}
        {Object.entries(statusDetail).map(([key, value]) => (
          <div key={key} className="grid gap-2">
            <Label htmlFor={`field-${key}`}>{key}</Label>
            {key.includes('Ï≤¥ÌÅ¨') || key.includes('ÏÉùÏÑ±') ? (
              <div className="flex items-center space-x-2">
                <Checkbox
                  id={`field-${key}`}
                  checked={dynamicFields[key] === 'true' || dynamicFields[key] === true}
                  onCheckedChange={(checked) => updateDynamicField(key, checked ? 'true' : 'false')}
                />
                <Label htmlFor={`field-${key}`}>{key}</Label>
              </div>
            ) : (
              <Input
                id={`field-${key}`}
                value={dynamicFields[key] || ''}
                onChange={(e) => updateDynamicField(key, e.target.value)}
                placeholder={`${key}ÏùÑ(Î•º) ÏûÖÎ†•ÌïòÏÑ∏Ïöî`}
              />
            )}
          </div>
        ))}
        
        {/* Î©îÎ™® ÌïÑÎìú */}
        <div className="grid gap-2">
          <Label htmlFor="memo">Î©îÎ™®</Label>
          <Textarea
            id="memo"
            value={memo}
            onChange={(e) => setMemo(e.target.value)}
            placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
            rows={3}
          />
        </div>
      </div>
    );
  };

  const handleStatusChange = async () => {
    if (!selectedStatus) {
      alert('Îã®Í≥ÑÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    try {
      const { data } = await updateMyBid({
        variables: {
          input: {
            nid: bid.nid,
            status: selectedStatus,
            memo: memo || null,
            detail: Object.keys(dynamicFields).length > 0 ? JSON.stringify(dynamicFields) : null
          }
        }
      });

      if (data?.mybidUpdate?.success) {
        if (selectedStatus === 'ÏùëÏ∞∞') {
          // ÏùëÏ∞∞ ÏÑ±Í≥µ Ïãú alert ÏóÜÏù¥ Ï¶âÏãú /mybids/bidding/[nid] ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
          router.push(`/mybids/bidding/${bid.nid}`);
        } else {
          alert(`Îã®Í≥ÑÍ∞Ä '${selectedStatus}'Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
          // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ Î≥ÄÍ≤ΩÎêú Ï†ïÎ≥¥ Î∞òÏòÅ
          router.refresh();
        }
      } else {
        throw new Error(data?.mybidUpdate?.message || 'Îã®Í≥Ñ Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('Îã®Í≥Ñ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
      alert('Îã®Í≥Ñ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  return (
    <div className="container mx-auto px-4 py-6 space-y-6">
      {/* ÏûÖÏ∞∞ Ï†ïÎ≥¥ */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Info className="w-5 h-5" />
            ÏûÖÏ∞∞ Ï†ïÎ≥¥
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ */}
          <div>
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <FileText className="w-4 h-4" />
                <h3 className="font-semibold">Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥</h3>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={() => {
                  if (isEditingNoticeDetails) {
                    saveNoticeDetailsFields();
                  } else {
                    setIsEditingNoticeDetails(true);
                  }
                }}
                disabled={updatingDetails || detailsLoading}
              >
                {updatingDetails ? (
                  <Loader2 className="h-4 w-4 animate-spin" />
                ) : (
                  isEditingNoticeDetails ? 'Ï†ÄÏû•' : 'Ìé∏Ïßë'
                )}
              </Button>
            </div>
            <div className="border rounded-lg p-4 space-y-3">
              {detailsLoading ? (
                <div className="flex items-center justify-center py-4">
                  <Loader2 className="w-5 h-5 animate-spin mr-2" />
                  <span>Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="flex flex-col gap-1">
                    <span className="text-sm text-gray-500">Í≥µÍ≥†Î™Ö</span>
                    {isEditingNoticeDetails ? (
                      <Input
                        value={noticeDetailsFields.title || ''}
                        onChange={(e) => updateNoticeDetailsField('title', e.target.value)}
                        placeholder="Í≥µÍ≥†Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        className="font-medium"
                      />
                    ) : (
                      <span className="font-medium">{noticeDetailsFields.title || bid.title || '-'}</span>
                    )}
                  </div>
                  <div className="flex flex-col gap-1">
                    <span className="text-sm text-gray-500">Í≥µÍ≥†Î≤àÌò∏</span>
                    {isEditingNoticeDetails ? (
                      <Input
                        value={noticeDetailsFields.notice_num || ''}
                        onChange={(e) => updateNoticeDetailsField('notice_num', e.target.value)}
                        placeholder="Í≥µÍ≥†Î≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        className="font-medium"
                      />
                    ) : (
                      <span className="font-medium">{noticeDetailsFields.notice_num || '-'}</span>
                    )}
                  </div>
                  <div className="flex flex-col gap-1">
                    <span className="text-sm text-gray-500">Îã¥ÎãπÎ∂ÄÏÑú</span>
                    {isEditingNoticeDetails ? (
                      <Input
                        value={noticeDetailsFields.org_dept || ''}
                        onChange={(e) => updateNoticeDetailsField('org_dept', e.target.value)}
                        placeholder="Îã¥ÎãπÎ∂ÄÏÑúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        className="font-medium"
                      />
                    ) : (
                      <span className="font-medium">{noticeDetailsFields.org_dept || bid.orgName || '-'}</span>
                    )}
                  </div>
                  <div className="flex flex-col gap-1">
                    <span className="text-sm text-gray-500">Îã¥ÎãπÏ†ÑÌôî</span>
                    {isEditingNoticeDetails ? (
                      <Input
                        value={noticeDetailsFields.org_tel || ''}
                        onChange={(e) => updateNoticeDetailsField('org_tel', e.target.value)}
                        placeholder="Îã¥ÎãπÏ†ÑÌôîÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        className="font-medium"
                      />
                    ) : (
                      <span className="font-medium">{noticeDetailsFields.org_tel || '-'}</span>
                    )}
                  </div>
                  <div className="flex flex-col gap-1">
                    <span className="text-sm text-gray-500">ÏóÖÎ¨¥Íµ¨Î∂Ñ</span>
                    {isEditingNoticeDetails ? (
                      <Input
                        value={noticeDetailsFields.category || ''}
                        onChange={(e) => updateNoticeDetailsField('category', e.target.value)}
                        placeholder="ÏóÖÎ¨¥Íµ¨Î∂ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        className="font-medium"
                      />
                    ) : (
                      <span className="font-medium">{noticeDetailsFields.category || bid.category || '-'}</span>
                    )}
                  </div>
                  <div className="flex flex-col gap-1">
                    <span className="text-sm text-gray-500">ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ</span>
                    {isEditingNoticeDetails ? (
                      <Input
                        value={noticeDetailsFields.detail_url || ''}
                        onChange={(e) => updateNoticeDetailsField('detail_url', e.target.value)}
                        placeholder="ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        className="font-medium"
                      />
                    ) : (
                      <div className="font-medium">
                        {noticeDetailsFields.detail_url ? (
                          <a
                            href={noticeDetailsFields.detail_url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-blue-600 hover:text-blue-800 hover:underline"
                          >
                            ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÎßÅÌÅ¨
                          </a>
                        ) : (
                          <span>-</span>
                        )}
                      </div>
                    )}
                  </div>
                  {(noticeDetailsFields.body_html || isEditingNoticeDetails) && (
                    <div className="col-span-1 md:col-span-2 flex flex-col gap-1">
                      <span className="text-sm text-gray-500">Í≥µÍ≥†Î≥∏Î¨∏</span>
                      {isEditingNoticeDetails ? (
                        <Textarea
                          value={noticeDetailsFields.body_html || ''}
                          onChange={(e) => updateNoticeDetailsField('body_html', e.target.value)}
                          placeholder="Í≥µÍ≥†Î≥∏Î¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                          rows={4}
                          className="font-medium"
                        />
                      ) : (
                        <div className="font-medium max-h-32 overflow-y-auto text-sm bg-gray-50 p-3 rounded">
                          {noticeDetailsFields.body_html ? (
                            <div dangerouslySetInnerHTML={{ __html: noticeDetailsFields.body_html }} />
                          ) : (
                            <span>-</span>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}
              {isEditingNoticeDetails && (
                <div className="flex justify-end gap-2 pt-2 border-t">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      setIsEditingNoticeDetails(false);
                      // ÏõêÎûò Îç∞Ïù¥ÌÑ∞Î°ú Î≥µÏõê
                      if (noticeDetailsData?.noticeDetails?.details) {
                        setNoticeDetailsFields(noticeDetailsData.noticeDetails.details);
                      }
                    }}
                  >
                    Ï∑®ÏÜå
                  </Button>
                </div>
              )}
            </div>
          </div>

          {/* ÏûÖÏ∞∞ ÏÉÅÏÑ∏Ï†ïÎ≥¥ */}
          <div>
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <Clock className="w-4 h-4" />
                <h3 className="font-semibold">ÏûÖÏ∞∞ ÏÉÅÏÑ∏Ï†ïÎ≥¥</h3>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={() => {
                  if (isEditingNotice) {
                    saveNoticeFields();
                  } else {
                    setIsEditingNotice(true);
                  }
                }}
                disabled={loading}
              >
                {loading ? (
                  <Loader2 className="h-4 w-4 animate-spin" />
                ) : (
                  isEditingNotice ? 'Ï†ÄÏû•' : 'Ìé∏Ïßë'
                )}
              </Button>
            </div>
            <div className="border rounded-lg p-4 space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {Object.entries(noticeFields).map(([key, value]) => (
                  <div key={key} className="flex flex-col gap-1">
                    <span className="text-sm text-gray-500">{key}</span>
                    {isEditingNotice ? (
                      <Input
                        value={noticeFields[key] || ''}
                        onChange={(e) => updateNoticeField(key, e.target.value)}
                        placeholder={`${key}ÏùÑ(Î•º) ÏûÖÎ†•ÌïòÏÑ∏Ïöî`}
                        className="font-medium"
                      />
                    ) : (
                      <span className="font-medium">{value || 'Ï†ïÎ≥¥ ÏóÜÏùå'}</span>
                    )}
                  </div>
                ))}
              </div>
              
              {/* Î©îÎ™® ÌïÑÎìú Ï∂îÍ∞Ä */}
              <div className="border-t pt-4 mt-4">
                <div className="flex flex-col gap-1">
                  <span className="text-sm text-gray-500">Î©îÎ™®</span>
                  {isEditingNotice ? (
                    <Textarea
                      value={progressMemo}
                      onChange={(e) => setProgressMemo(e.target.value)}
                      placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                      rows={3}
                      className="font-medium"
                    />
                  ) : (
                    <div className="font-medium p-3 bg-gray-50 rounded border min-h-[80px]">
                      {progressMemo || 'Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.'}
                    </div>
                  )}
                </div>
              </div>
              
              {isEditingNotice && (
                <div className="flex justify-end gap-2 pt-2 border-t">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      setIsEditingNotice(false);
                      // ÏõêÎûò Îç∞Ïù¥ÌÑ∞Î°ú Î≥µÏõê
                      const bidDetail = detailData['ÏûÖÏ∞∞'] || {};
                      setNoticeFields(bidDetail);
                      setProgressMemo(extractProgressMemo());
                    }}
                  >
                    Ï∑®ÏÜå
                  </Button>
                </div>
              )}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* ÏûÖÏ∞∞ Î¨∏ÏÑú */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <FileText className="w-5 h-5" />
            ÏûÖÏ∞∞ Î¨∏ÏÑú
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Í≥µÍ≥† Î¨∏ÏÑú */}
          <div>
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <FileText className="w-4 h-4" />
                <h3 className="font-semibold">Í≥µÍ≥† Î¨∏ÏÑú</h3>
              </div>
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setIsEditingFiles(!isEditingFiles)}
                >
                  {isEditingFiles ? 'Ï†ÄÏû•' : 'Ìé∏Ïßë'}
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    // TODO: Ï∂îÍ∞Ä Í∏∞Îä• Íµ¨ÌòÑ
                    alert('ÌååÏùº Ï∂îÍ∞Ä Í∏∞Îä• Íµ¨ÌòÑ ÏòàÏ†ï');
                  }}
                >
                  <Plus className="w-4 h-4 mr-1" />
                  Ï∂îÍ∞Ä
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    // TODO: ÏÑ†ÌÉùÎêú ÌååÏùºÎì§ Îã§Ïö¥Î°úÎìú Í∏∞Îä• Íµ¨ÌòÑ
                    if (selectedDownloads.size > 0) {
                      alert(`${selectedDownloads.size}Í∞ú ÌååÏùº Îã§Ïö¥Î°úÎìú Í∏∞Îä• Íµ¨ÌòÑ ÏòàÏ†ï`);
                    } else {
                      alert('Îã§Ïö¥Î°úÎìúÌï† ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                    }
                  }}
                  disabled={selectedDownloads.size === 0}
                >
                  <Download className="w-4 h-4 mr-1" />
                  Îã§Ïö¥
                </Button>
              </div>
            </div>
            <div className="border rounded-lg p-4 space-y-3">
              {filesLoading ? (
                <div className="flex items-center justify-center py-8">
                  <Loader2 className="w-6 h-6 animate-spin" />
                  <span className="ml-2">ÌååÏùº Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
                </div>
              ) : noticeFilesData?.noticeFiles?.files?.length > 0 ? (
                <>
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead className="text-center w-20">ÏàúÎ≤à</TableHead>
                        <TableHead>ÌååÏùº</TableHead>
                        <TableHead className="text-center w-24">Îã§Ïö¥Î°úÎìú</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {noticeFilesData.noticeFiles.files.map((file: any, index: number) => (
                        <TableRow key={index}>
                          <TableCell className="text-center font-medium">
                            {file.order || '-'}
                          </TableCell>
                          <TableCell>
                            <div className="flex items-center gap-2">
                              <FileText className="w-4 h-4 text-gray-500" />
                              {isEditingFiles ? (
                                <Input
                                  value={file.file_name}
                                  onChange={(e) => {
                                    // TODO: ÌååÏùºÎ™Ö Ìé∏Ïßë Í∏∞Îä• Íµ¨ÌòÑ
                                  }}
                                  className="flex-1"
                                />
                              ) : (
                                <div className="flex-1">
                                  <button
                                    className="text-left text-blue-600 hover:text-blue-800 hover:underline focus:outline-none"
                                    onClick={() => openFileViewer(file.file_name, file.file_url)}
                                    title="ÌÅ¥Î¶≠ÌïòÏó¨ ÌååÏùº Î∑∞Ïñ¥ Ïó¥Í∏∞"
                                  >
                                    {file.file_name}
                                  </button>
                                </div>
                              )}
                            </div>
                          </TableCell>
                          <TableCell className="text-center">
                            <Checkbox
                              checked={selectedDownloads.has(file.file_name)}
                              onCheckedChange={(checked) => {
                                const newSet = new Set(selectedDownloads);
                                if (checked) {
                                  newSet.add(file.file_name);
                                } else {
                                  newSet.delete(file.file_name);
                                }
                                setSelectedDownloads(newSet);
                              }}
                            />
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                  <div className="pt-2 border-t space-y-3">
                    <div className="text-sm text-gray-500">
                      Ï¥ù {noticeFilesData.noticeFiles.total_count}Í∞ú ÌååÏùº ‚Ä¢ ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: {bid.postedAt?.split('T')[0]}
                    </div>
                    
                    {/* NAS Í≤ΩÎ°ú ÌëúÏãú */}
                    {(() => {
                      const nasPath = noticeFilesData.noticeFiles.files.find((f: any) => f.down_folder)?.down_folder;
                      return nasPath ? (
                        <div className="bg-gray-50 p-3 rounded-lg">
                          <div className="text-sm font-medium text-gray-700 mb-1">NAS Í≤ΩÎ°ú (Î°úÏª¨ Í≤ΩÎ°ú)</div>
                          <div className="text-sm text-gray-600 font-mono break-all">{nasPath}</div>
                        </div>
                      ) : null;
                    })()}
                    
                    <div className="flex justify-end">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          // TODO: NAS ÌååÏùº Î∏åÎùºÏö∞Ï†Ä Íµ¨ÌòÑ
                          const nasPath = noticeFilesData.noticeFiles.files.find((f: any) => f.down_folder)?.down_folder;
                          if (nasPath) {
                            alert(`NAS ÌååÏùº Î∏åÎùºÏö∞Ï†Ä Íµ¨ÌòÑ ÏòàÏ†ï\nÍ≤ΩÎ°ú: ${nasPath}`);
                          } else {
                            alert('Î°úÏª¨ ÌååÏùº Í≤ΩÎ°úÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                          }
                        }}
                      >
                        <FileText className="w-4 h-4 mr-1" />
                        NAS ÌååÏùº Î≥¥Í∏∞
                      </Button>
                    </div>
                  </div>
                  {selectedDownloads.size > 0 && (
                    <div className="flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                      <span className="text-sm text-blue-800">
                        {selectedDownloads.size}Í∞ú ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìú ÎåÄÏÉÅÏúºÎ°ú ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.
                      </span>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          // TODO: ÏÑ†ÌÉùÎêú ÌååÏùºÎì§ Îã§Ïö¥Î°úÎìú Í∏∞Îä• Íµ¨ÌòÑ
                          alert('ÏÑ†ÌÉùÎêú ÌååÏùº Îã§Ïö¥Î°úÎìú Í∏∞Îä• Íµ¨ÌòÑ ÏòàÏ†ï');
                        }}
                      >
                        ÏÑ†ÌÉù Îã§Ïö¥Î°úÎìú
                      </Button>
                    </div>
                  )}
                </>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  Í≥µÍ≥† Î¨∏ÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
              )}
            </div>
          </div>

          {/* Î¨∏ÏÑú ÏûëÏÑ± */}
          <div>
            <div className="flex items-center gap-2 mb-4">
              <Edit3 className="w-4 h-4" />
              <h3 className="font-semibold">Î¨∏ÏÑú ÏûëÏÑ±</h3>
            </div>
            <div className="border rounded-lg p-4 space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Button variant="outline" className="h-20 flex flex-col gap-2">
                  <FileText className="w-6 h-6" />
                  <span>ÏûÖÏ∞∞ÏÑú ÏûëÏÑ±</span>
                </Button>
                <Button variant="outline" className="h-20 flex flex-col gap-2">
                  <Edit3 className="w-6 h-6" />
                  <span>ÏÇ¨ÏóÖÍ≥ÑÌöçÏÑú ÏûëÏÑ±</span>
                </Button>
                <Button variant="outline" className="h-20 flex flex-col gap-2">
                  <FileText className="w-6 h-6" />
                  <span>Í∏∞Ïà†Ï†úÏïàÏÑú ÏûëÏÑ±</span>
                </Button>
                <Button variant="outline" className="h-20 flex flex-col gap-2">
                  <Edit3 className="w-6 h-6" />
                  <span>ÌååÏùº ÏóÖÎ°úÎìú</span>
                </Button>
              </div>
              <div className="text-sm text-gray-500">
                ÏûÖÏ∞∞ ÎßàÍ∞êÏùºÍπåÏßÄ Î™®Îì† ÌïÑÏàò ÏÑúÎ•òÎ•º Ï†úÏ∂úÌï¥Ïïº Ìï©ÎãàÎã§.
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Îã®Í≥Ñ Î≥ÄÍ≤Ω */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <CheckSquare className="w-5 h-5" />
            Îã®Í≥Ñ Î≥ÄÍ≤Ω
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="flex flex-wrap gap-4">
              {statusOptions.map((option) => (
                <div key={option.value} className="flex items-center space-x-2">
                  <Checkbox
                    id={`status-${option.value}`}
                    checked={selectedStatus === option.value}
                    onCheckedChange={() => {
                      setSelectedStatus(option.value);
                      loadStatusData(option.value);
                    }}
                  />
                  <Label htmlFor={`status-${option.value}`}>{option.label}</Label>
                </div>
              ))}
            </div>
            
            {renderDynamicFields()}

            {selectedStatus && (
              <div className="flex justify-end pt-4">
                <Button onClick={handleStatusChange} disabled={loading}>
                  {loading ? (
                    <>
                      <Loader2 className="h-4 w-4 animate-spin mr-2" />
                      Ï≤òÎ¶¨ Ï§ë...
                    </>
                  ) : (
                    'Îã®Í≥Ñ Î≥ÄÍ≤Ω'
                  )}
                </Button>
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}