'use client';

import React, { useState } from 'react';
import { Separator } from '@/components/ui/separator';
import { Button } from '@/components/ui/button';
import { ButtonWithIcon, ButtonWithColorIcon, DropdownSectionHeader, TabHeader, TabContainer } from '@/components/shared/FormComponents';
import { SectionTitleHelp } from '@/components/shared/Help';
import { SectionWithGuide } from '@/components/shared/SectionWithGuide';
import { PageHeader } from '@/components/shared/PageHeader';
import { Checkbox } from '@/components/ui/checkbox';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from '@/components/ui/table';
import {
  FileText,
  Info,
  Clock,
  Edit3,
  CheckSquare,
  Building,
  Calendar,
  User,
  Loader2,
  Plus,
  Download,
  ExternalLink,
  ChevronDown,
  ChevronUp,
  X,
  Trophy,
  XCircle,
  RefreshCw,
  ArrowRight,
  HelpCircle
} from 'lucide-react';
import { useMutation, useQuery, gql } from '@apollo/client';
import { useRouter } from 'next/navigation';

const UPDATE_MYBID = gql`
  mutation UpdateMyBid($input: MyBidUpdateInput!) {
    mybidUpdate(input: $input) {
      success
      message
      nid
      status
    }
  }
`;

const GET_NOTICE_FILES = gql`
  query GetNoticeFiles($nid: Int!) {
    noticeFiles(nid: $nid) {
      success
      nid
      files {
        file_name
        file_url
        down_folder
        source
        order
      }
      total_count
    }
  }
`;

const GET_NOTICE_DETAILS = gql`
  query GetNoticeDetails($nid: Int!) {
    noticeDetails(nid: $nid) {
      success
      nid
      details {
        title
        notice_num
        org_dept
        org_tel
        body_html
        detail_url
        category
      }
      message
    }
  }
`;

const UPDATE_NOTICE_DETAILS = gql`
  mutation UpdateNoticeDetails($nid: Int!, $input: NoticeDetailsInput!) {
    noticeDetailsUpdate(nid: $nid, input: $input) {
      success
      message
      nid
    }
  }
`;

interface Bid {
  mid: number;
  nid: number;
  title: string;
  status: string;
  startedAt?: string;
  endedAt?: string;
  memo?: string;
  orgName: string;
  postedAt: string;
  detail?: string;
  category?: string;
  region?: string;
}

interface BidDetailViewProps {
  bid: Bid;
}

export default function BidDetailView({ bid }: BidDetailViewProps) {
  const router = useRouter();
  const [updateMyBid, { loading }] = useMutation(UPDATE_MYBID);
  const { data: noticeFilesData, loading: filesLoading, refetch: refetchFiles } = useQuery(GET_NOTICE_FILES, {
    variables: { nid: bid.nid },
    errorPolicy: 'all'
  });
  
  const { data: noticeDetailsData, loading: detailsLoading, refetch: refetchDetails } = useQuery(GET_NOTICE_DETAILS, {
    variables: { nid: bid.nid },
    errorPolicy: 'all'
  });
  
  const [updateNoticeDetails, { loading: updatingDetails }] = useMutation(UPDATE_NOTICE_DETAILS);
  
  const [selectedStatus, setSelectedStatus] = useState('');
  const [memo, setMemo] = useState('');
  const [dynamicFields, setDynamicFields] = useState<Record<string, any>>({});
  const [noticeFields, setNoticeFields] = useState<Record<string, any>>({});
  const [isEditingNotice, setIsEditingNotice] = useState(false);
  const [isEditingFiles, setIsEditingFiles] = useState(false);
  const [selectedDownloads, setSelectedDownloads] = useState<Set<string>>(new Set());
  const [isEditingNoticeDetails, setIsEditingNoticeDetails] = useState(false);
  const [noticeDetailsFields, setNoticeDetailsFields] = useState<Record<string, any>>({});
  const [progressMemo, setProgressMemo] = useState('');
  
  // ÏÑπÏÖò Ï†ëÌûò/ÌéºÏπ® ÏÉÅÌÉú
  const [isInfoExpanded, setIsInfoExpanded] = useState(true);
  const [isDocumentExpanded, setIsDocumentExpanded] = useState(true);
  const [isStageExpanded, setIsStageExpanded] = useState(true);

  // ÏóÖÎ¨¥ Í∞ÄÏù¥Îìú ÌëúÏãú ÏÉÅÌÉú
  const [isInfoGuideOpen, setIsInfoGuideOpen] = useState(false);
  const [isDocumentGuideOpen, setIsDocumentGuideOpen] = useState(false);
  const [isStageGuideOpen, setIsStageGuideOpen] = useState(false);

  // ÌéòÏù¥ÏßÄ ÌÉÄÏù¥ÌãÄ
  const pageTitle = "ÏûÖÏ∞∞ ÏßÑÌñâ ÏÉÅÏÑ∏";
  
  // ÌÉ≠ ÏÉÅÌÉú
  const [infoActiveTab, setInfoActiveTab] = useState('notice');
  const [documentActiveTab, setDocumentActiveTab] = useState('files');
  const [stageActiveTab, setStageActiveTab] = useState('ÏùëÏ∞∞');

  // ÌååÏùº Î∑∞Ïñ¥ Ìï®Ïàò
  const openFileViewer = (fileName: string, fileUrl: string) => {
    const fileExt = fileName.split('.').pop()?.toLowerCase();
    
    if (!fileUrl) {
      alert('ÌååÏùº URLÏù¥ ÏóÜÏäµÎãàÎã§.');
      return;
    }

    // ÌååÏùº ÌôïÏû•ÏûêÏóê Îî∞Î•∏ Ï≤òÎ¶¨
    switch (fileExt) {
      case 'pdf':
        // PDF Î∑∞Ïñ¥ - Google Docs Viewer ÏÇ¨Ïö©ÌïòÏó¨ Îã§Ïö¥Î°úÎìú Î∞©ÏßÄ
        const pdfViewerContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>PDF Viewer - ${fileName}</title>
            <meta charset="utf-8">
            <style>
              body { 
                margin: 0; 
                padding: 0; 
                font-family: Arial, sans-serif;
              }
              .header {
                background: #f8f9fa;
                padding: 10px 20px;
                border-bottom: 1px solid #dee2e6;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              .title {
                font-weight: bold;
                color: #495057;
              }
              .download-btn {
                background: #007bff;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                text-decoration: none;
                font-size: 14px;
              }
              .download-btn:hover {
                background: #0056b3;
              }
              .pdf-container {
                width: 100%;
                height: calc(100vh - 60px);
              }
              .pdf-frame {
                width: 100%;
                height: 100%;
                border: none;
              }
              .loading {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100%;
                color: #666;
              }
            </style>
          </head>
          <body>
            <div class="header">
              <div class="title">üìÑ ${fileName}</div>
              <a href="${fileUrl}" target="_blank" class="download-btn">Îã§Ïö¥Î°úÎìú</a>
            </div>
            <div class="pdf-container">
              <div class="loading">PDFÎ•º Î°úÎìúÌïòÎäî Ï§ë...</div>
              <iframe 
                src="https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true" 
                class="pdf-frame"
                onload="document.querySelector('.loading').style.display='none'; this.style.display='block'"
                style="display: none;">
              </iframe>
            </div>
          </body>
          </html>
        `;
        const pdfBlob = new Blob([pdfViewerContent], { type: 'text/html' });
        const pdfUrl = URL.createObjectURL(pdfBlob);
        window.open(pdfUrl, '_blank');
        break;
      
      case 'xlsx':
      case 'xls':
        // Excel ÌååÏùº - Google Docs Viewer ÏÇ¨Ïö©
        const excelViewerContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Excel Viewer - ${fileName}</title>
            <meta charset="utf-8">
            <style>
              body { 
                margin: 0; 
                padding: 0; 
                font-family: Arial, sans-serif;
              }
              .header {
                background: #f8f9fa;
                padding: 10px 20px;
                border-bottom: 1px solid #dee2e6;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              .title {
                font-weight: bold;
                color: #495057;
              }
              .download-btn {
                background: #28a745;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                text-decoration: none;
                font-size: 14px;
              }
              .download-btn:hover {
                background: #1e7e34;
              }
              .excel-container {
                width: 100%;
                height: calc(100vh - 60px);
              }
              .excel-frame {
                width: 100%;
                height: 100%;
                border: none;
              }
            </style>
          </head>
          <body>
            <div class="header">
              <div class="title">üìä ${fileName}</div>
              <a href="${fileUrl}" target="_blank" class="download-btn">Îã§Ïö¥Î°úÎìú</a>
            </div>
            <div class="excel-container">
              <iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true" class="excel-frame"></iframe>
            </div>
          </body>
          </html>
        `;
        const excelBlob = new Blob([excelViewerContent], { type: 'text/html' });
        const excelUrl = URL.createObjectURL(excelBlob);
        window.open(excelUrl, '_blank');
        break;
      
      case 'hwp':
      case 'hwpx':
        // HWP ÌååÏùº - Íµ¨ÌòÑ Ï§ë Î©îÏãúÏßÄ
        const hwpViewerContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>HWP Viewer</title>
            <meta charset="utf-8">
            <style>
              body { 
                font-family: Arial, sans-serif; 
                display: flex; 
                justify-content: center; 
                align-items: center; 
                height: 100vh; 
                margin: 0; 
                background-color: #f5f5f5;
              }
              .message { 
                text-align: center; 
                padding: 40px; 
                background: white; 
                border-radius: 8px; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
              }
              .file-name { 
                color: #666; 
                margin-top: 10px; 
                font-size: 14px; 
              }
            </style>
          </head>
          <body>
            <div class="message">
              <h2>üìÑ HWPX Viewer</h2>
              <p>hwpx viewerÎäî Íµ¨ÌòÑÏ§ëÏûÖÎãàÎã§</p>
              <div class="file-name">${fileName}</div>
            </div>
          </body>
          </html>
        `;
        const hwpBlob = new Blob([hwpViewerContent], { type: 'text/html' });
        const hwpUrl = URL.createObjectURL(hwpBlob);
        window.open(hwpUrl, '_blank');
        break;
      
      case 'doc':
      case 'docx':
        // Word ÌååÏùº - Google Docs Viewer ÏÇ¨Ïö©
        const wordViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true`;
        window.open(wordViewerUrl, '_blank');
        break;
      
      case 'ppt':
      case 'pptx':
        // PowerPoint ÌååÏùº - Google Docs Viewer ÏÇ¨Ïö©
        const pptViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true`;
        window.open(pptViewerUrl, '_blank');
        break;
      
      default:
        // Í∏∞ÌÉÄ ÌååÏùº - Í∏∞Î≥∏ Î∏åÎùºÏö∞Ï†Ä Ï≤òÎ¶¨
        window.open(fileUrl, '_blank');
        break;
    }
  };

  // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÌååÏã±
  const parseDetailData = () => {
    try {
      return bid.detail ? JSON.parse(bid.detail) : {};
    } catch (e) {
      console.error('Failed to parse detail:', e);
      return {};
    }
  };

  const parseMemoData = () => {
    try {
      return bid.memo ? JSON.parse(bid.memo) : {};
    } catch (e) {
      console.error('Failed to parse memo:', e);
      return {};
    }
  };

  const detailData = parseDetailData();
  const memoData = parseMemoData();

  // ÏßÑÌñâ Î©îÎ™® ÌÖçÏä§Ìä∏Îßå Ï∂îÏ∂úÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
  const extractProgressMemo = () => {
    let progressMemoData = memoData['ÏßÑÌñâ'] || '';
    
    // ÎßåÏïΩ progressMemoDataÍ∞Ä JSON Í∞ùÏ≤¥ÎùºÎ©¥ ÌÖçÏä§Ìä∏Îßå Ï∂îÏ∂ú
    if (typeof progressMemoData === 'object') {
      progressMemoData = progressMemoData['ÏßÑÌñâ'] || '';
    }
    
    // ÎßåÏïΩ JSON Î¨∏ÏûêÏó¥Ïù¥ÎùºÎ©¥ ÌååÏã±Ìï¥ÏÑú ÌÖçÏä§Ìä∏Îßå Ï∂îÏ∂ú
    if (typeof progressMemoData === 'string' && progressMemoData.startsWith('{')) {
      try {
        const parsed = JSON.parse(progressMemoData);
        progressMemoData = parsed['ÏßÑÌñâ'] || progressMemoData;
      } catch (e) {
        // JSON ÌååÏã± Ïã§Ìå®Ïãú ÏõêÎ≥∏ Î¨∏ÏûêÏó¥ ÏÇ¨Ïö©
        console.log('Failed to parse memo as JSON, using as text:', progressMemoData);
      }
    }
    
    return progressMemoData;
  };

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú ÏûÖÏ∞∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  React.useEffect(() => {
    const bidDetail = detailData['ÏûÖÏ∞∞'] || {};
    setNoticeFields(bidDetail);
  }, []);

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú ÏßÑÌñâ Î©îÎ™® Î°úÎìú
  React.useEffect(() => {
    setProgressMemo(extractProgressMemo());
  }, []);

  // ÌååÏùº Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÎ©¥ Îã§Ïö¥Î°úÎìú Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî
  React.useEffect(() => {
    if (noticeFilesData?.noticeFiles?.files) {
      const newSelectedDownloads = new Set<string>();
      noticeFilesData.noticeFiles.files.forEach((file: any) => {
        // down_folderÏóê ÎÇ¥Ïö©Ïù¥ ÏóÜÎäî Í≤ΩÏö∞: Ï≤¥ÌÅ¨Îê®, ÏûàÎäî Í≤ΩÏö∞: Ï≤¥ÌÅ¨ ÏïàÎê®
        if (!file.down_folder || file.down_folder.trim() === '') {
          newSelectedDownloads.add(file.file_name);
        }
      });
      setSelectedDownloads(newSelectedDownloads);
    }
  }, [noticeFilesData]);

  // Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÎ©¥ ÌïÑÎìú Ï¥àÍ∏∞Ìôî
  React.useEffect(() => {
    if (noticeDetailsData?.noticeDetails?.details) {
      setNoticeDetailsFields(noticeDetailsData.noticeDetails.details);
    }
  }, [noticeDetailsData]);

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú Í∏∞Î≥∏ 'ÏùëÏ∞∞' ÏÉÅÌÉú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  React.useEffect(() => {
    setSelectedStatus('ÏùëÏ∞∞');
    loadStatusData('ÏùëÏ∞∞');
  }, []);

  // ÏÑ†ÌÉùÎêú ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎê† Îïå Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î°ú Ìèº ÌïÑÎìú Ï¥àÍ∏∞Ìôî
  const loadStatusData = (status: string) => {
    const statusDetail = detailData[status] || {};
    const statusMemo = memoData[status] || '';
    
    setMemo(statusMemo);
    setDynamicFields(statusDetail);
  };

  // ÎèôÏ†Å ÌïÑÎìú Í∞í ÏóÖÎç∞Ïù¥Ìä∏
  const updateDynamicField = (key: string, value: any) => {
    setDynamicFields(prev => ({ ...prev, [key]: value }));
  };

  // Í≥µÍ≥† ÌïÑÎìú Í∞í ÏóÖÎç∞Ïù¥Ìä∏
  const updateNoticeField = (key: string, value: any) => {
    setNoticeFields(prev => ({ ...prev, [key]: value }));
  };

  // ÏûÖÏ∞∞ Ï†ïÎ≥¥ Ï†ÄÏû•
  const saveNoticeFields = async () => {
    try {
      // Îëê Î≤àÏùò API Ìò∏Ï∂úÎ°ú Î∂ÑÎ¶¨: Î®ºÏ†Ä ÏûÖÏ∞∞ detail Ï†ÄÏû•, Í∑∏Îã§Ïùå ÏßÑÌñâ memo Ï†ÄÏû•
      
      // 1. ÏûÖÏ∞∞ ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû• (detail ÌïÑÎìúÎ•º 'ÏûÖÏ∞∞' ÏÉÅÌÉúÎ°ú Ï†ÄÏû•)
      const { data: detailResult } = await updateMyBid({
        variables: {
          input: {
            nid: bid.nid,
            status: 'ÏûÖÏ∞∞', // detailÏùÑ 'ÏûÖÏ∞∞' ÏÉÅÌÉúÎ°ú Ï†ÄÏû•
            memo: null,
            detail: JSON.stringify(noticeFields) // noticeFields ÏûêÏ≤¥Î•º Ï†ÄÏû•
          }
        }
      });

      if (!detailResult?.mybidUpdate?.success) {
        throw new Error(detailResult?.mybidUpdate?.message || 'ÏûÖÏ∞∞ Ï†ïÎ≥¥ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }

      // 2. ÏßÑÌñâ Î©îÎ™® Ï†ÄÏû• (memo ÌïÑÎìúÎ•º 'ÏßÑÌñâ' ÏÉÅÌÉúÎ°ú Ï†ÄÏû•)
      const { data: memoResult } = await updateMyBid({
        variables: {
          input: {
            nid: bid.nid,
            status: 'ÏßÑÌñâ', // memoÎ•º 'ÏßÑÌñâ' ÏÉÅÌÉúÎ°ú Ï†ÄÏû•
            memo: progressMemo,
            detail: null
          }
        }
      });

      if (!memoResult?.mybidUpdate?.success) {
        throw new Error(memoResult?.mybidUpdate?.message || 'Î©îÎ™® Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }

      setIsEditingNotice(false);
      router.refresh();
    } catch (error) {
      console.error('ÏûÖÏ∞∞ Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
      alert('ÏûÖÏ∞∞ Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  // Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏
  const updateNoticeDetailsField = (key: string, value: any) => {
    setNoticeDetailsFields(prev => ({ ...prev, [key]: value }));
  };

  // Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû•
  const saveNoticeDetailsFields = async () => {
    try {
      // __typename ÌïÑÎìú Ï†úÍ±∞ Î∞è null Í∞í Ï≤òÎ¶¨
      const cleanInput = Object.keys(noticeDetailsFields).reduce((acc, key) => {
        if (key !== '__typename') {
          acc[key] = noticeDetailsFields[key] || '';
        }
        return acc;
      }, {} as any);

      const { data } = await updateNoticeDetails({
        variables: {
          nid: bid.nid,
          input: cleanInput
        }
      });

      if (data?.noticeDetailsUpdate?.success) {
        setIsEditingNoticeDetails(false);
        refetchDetails();
        alert('Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.');
      } else {
        throw new Error(data?.noticeDetailsUpdate?.message || 'Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
      alert('Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  const saveFilesData = () => {
    // TODO: ÌååÏùº Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Í∏∞Îä• Íµ¨ÌòÑ
    alert('ÌååÏùº Ï†ÄÏû• Í∏∞Îä• Íµ¨ÌòÑ ÏòàÏ†ï');
    setIsEditingFiles(false);
  };

  const statusOptions = [
    { value: 'ÏùëÏ∞∞', label: 'ÏùëÏ∞∞' },
    { value: 'ÎÇôÏ∞∞', label: 'ÎÇôÏ∞∞' },
    { value: 'Ìå®Ï∞∞', label: 'Ìå®Ï∞∞' },
    { value: 'Ìè¨Í∏∞', label: 'Ìè¨Í∏∞' }
  ];

  const renderDynamicFields = () => {
    if (!selectedStatus) return null;

    // ÌòÑÏû¨ ÏÉÅÌÉúÏóê ÎåÄÌïú detail Îç∞Ïù¥ÌÑ∞
    const statusDetail = detailData[selectedStatus] || {};
    
    return (
      <div className="grid gap-4 mt-4 p-4  rounded-lg">
        {/* ÎèôÏ†ÅÏúºÎ°ú detail ÌïÑÎìúÎì§ ÏÉùÏÑ± */}
        {Object.entries(statusDetail).map(([key, value]) => (
          <div key={key} className="grid gap-2">
            <Label htmlFor={`field-${key}`}>{key}</Label>
            {key.includes('Ï≤¥ÌÅ¨') || key.includes('ÏÉùÏÑ±') ? (
              <div className="flex items-center space-x-2">
                <Checkbox
                  id={`field-${key}`}
                  checked={dynamicFields[key] === 'true' || dynamicFields[key] === true}
                  onCheckedChange={(checked) => updateDynamicField(key, checked ? 'true' : 'false')}
                />
                <Label htmlFor={`field-${key}`}>{key}</Label>
              </div>
            ) : (
              <Input
                id={`field-${key}`}
                value={dynamicFields[key] || ''}
                onChange={(e) => updateDynamicField(key, e.target.value)}
                placeholder={`${key}ÏùÑ(Î•º) ÏûÖÎ†•ÌïòÏÑ∏Ïöî`}
              />
            )}
          </div>
        ))}
        
        {/* Î©îÎ™® ÌïÑÎìú */}
        <div className="grid gap-2">
          <Label htmlFor="memo">Î©îÎ™®</Label>
          <Textarea
            id="memo"
            value={memo}
            onChange={(e) => setMemo(e.target.value)}
            placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
            rows={3}
          />
        </div>
      </div>
    );
  };

  const handleStatusChange = async () => {
    if (!selectedStatus) {
      alert('Îã®Í≥ÑÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    try {
      const { data } = await updateMyBid({
        variables: {
          input: {
            nid: bid.nid,
            status: selectedStatus,
            memo: memo || null,
            detail: Object.keys(dynamicFields).length > 0 ? JSON.stringify(dynamicFields) : null
          }
        }
      });

      if (data?.mybidUpdate?.success) {
        if (selectedStatus === 'ÏùëÏ∞∞') {
          // ÏùëÏ∞∞ ÏÑ±Í≥µ Ïãú alert ÏóÜÏù¥ Ï¶âÏãú /mybids/bidding/[nid] ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
          router.push(`/mybids/bidding/${bid.nid}`);
        } else {
          alert(`Îã®Í≥ÑÍ∞Ä '${selectedStatus}'Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
          // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ Î≥ÄÍ≤ΩÎêú Ï†ïÎ≥¥ Î∞òÏòÅ
          router.refresh();
        }
      } else {
        throw new Error(data?.mybidUpdate?.message || 'Îã®Í≥Ñ Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('Îã®Í≥Ñ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
      alert('Îã®Í≥Ñ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  return (
    <div className="container mx-auto px-4 py-6 space-y-5">
      {/* ÌéòÏù¥ÏßÄ Ìó§Îçî */}
      <PageHeader
        title="ÏûÖÏ∞∞ ÏßÑÌñâ ÏÉÅÏÑ∏"
        breadcrumbs={[
          { label: 'Ìôà', href: '/' },
          { label: 'ÎÇòÏùò ÏûÖÏ∞∞', href: '/mybids' },
          { label: 'ÏßÑÌñâ', href: '/mybids/progress' },
          { label: bid.title, href: `/mybids/progress/${bid.nid}` }
        ]}
        helpTooltip="ÏûÖÏ∞∞ ÏßÑÌñâ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ ÎèÑÏõÄÎßê"
        helpContent="ÏûÖÏ∞∞ ÏßÑÌñâ Ï§ëÏù∏ Í≥µÍ≥†Ïùò ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÍ≥† Í¥ÄÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§. ÏûÖÏ∞∞ Ï†ïÎ≥¥, Î¨∏ÏÑú Í¥ÄÎ¶¨, Îã®Í≥Ñ Î≥ÄÍ≤Ω Îì±Ïùò Í∏∞Îä•ÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§."
      />

      {/* ÏûÖÏ∞∞ Ï†ïÎ≥¥ */}
      <div>
        <div className="flex items-center gap-2">
          <DropdownSectionHeader
            title="ÏûÖÏ∞∞ Ï†ïÎ≥¥"
            icon={<Info className="w-5 h-5" />}
            isExpanded={isInfoExpanded}
            onToggle={() => setIsInfoExpanded(!isInfoExpanded)}
            accentColor="#6366f1"
          />
          <SectionTitleHelp
            isOpen={isInfoGuideOpen}
            onToggle={() => setIsInfoGuideOpen(!isInfoGuideOpen)}
          />
        </div>

        {/* ÏûÖÏ∞∞ Ï†ïÎ≥¥ ÏóÖÎ¨¥ Í∞ÄÏù¥Îìú */}
        {isInfoGuideOpen && (
          <div className="mt-2 bg-blue-50 border border-blue-200 p-4 rounded-lg">
            <div className="max-w-full">
              <h4 className="font-semibold text-blue-800 mb-2">ÏûÖÏ∞∞ Ï†ïÎ≥¥ ÏóÖÎ¨¥ Í∞ÄÏù¥Îìú</h4>
              <div className="text-sm text-blue-700 space-y-2">
                <p>‚Ä¢ Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥: ÏûÖÏ∞∞ Í≥µÍ≥†Ïùò Í∏∞Î≥∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÍ≥† Ìé∏ÏßëÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                <p>‚Ä¢ ÏûÖÏ∞∞ ÏÉÅÏÑ∏Ï†ïÎ≥¥: ÏûÖÏ∞∞Í≥º Í¥ÄÎ†®Îêú ÏÑ∏Î∂Ä ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÍ≥† Í¥ÄÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                <p>‚Ä¢ Ìé∏Ïßë Î™®ÎìúÏóêÏÑú Ï†ïÎ≥¥Î•º ÏàòÏ†ïÌïú ÌõÑ Î∞òÎìúÏãú Ï†ÄÏû• Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Ï†ÅÏö©ÌïòÏÑ∏Ïöî.</p>
              </div>
            </div>
          </div>
        )}

        {isInfoExpanded && (
          <div className="mt-2 space-y-0">
            {/* ÌÉ≠ Î≤ÑÌäº */}
            <TabHeader
              tabs={[
                {
                  id: 'notice',
                  label: 'Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥',
                  icon: <FileText className="w-4 h-4" />
                },
                {
                  id: 'bid',
                  label: 'ÏûÖÏ∞∞ ÏÉÅÏÑ∏Ï†ïÎ≥¥',
                  icon: <Clock className="w-4 h-4" />
                }
              ]}
              activeTab={infoActiveTab}
              onTabChange={setInfoActiveTab}
            />
            
            {/* Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÌÉ≠ */}
            {infoActiveTab === 'notice' && (
              <div>
                <TabContainer>
                  {detailsLoading ? (
                    <div className="flex items-center justify-center py-4">
                      <Loader2 className="w-5 h-5 animate-spin mr-2" />
                      <span>Í≥µÍ≥† ÏÉÅÏÑ∏Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {/* Í≥µÍ≥†Î™Ö */}
                      <div className="flex items-center">
                        <span className="text-sm w-20 flex-shrink-0 text-gray-500">Í≥µÍ≥†Î™Ö</span>
                        {isEditingNoticeDetails ? (
                          <Input
                            value={noticeDetailsFields.title || ''}
                            onChange={(e) => updateNoticeDetailsField('title', e.target.value)}
                            placeholder="Í≥µÍ≥†Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            className="flex-1" style={{color: 'var(--color-primary-foreground)'}}
                          />
                        ) : (
                          <span className="flex-1" style={{color: 'var(--color-primary-foreground)'}}>{noticeDetailsFields.title || bid.title || '-'}</span>
                        )}
                      </div>

                      {/* Í≥µÍ≥†Î≤àÌò∏ */}
                      <div className="flex items-center">
                        <span className="text-sm w-20 flex-shrink-0 text-gray-500">Í≥µÍ≥†Î≤àÌò∏</span>
                        {isEditingNoticeDetails ? (
                          <Input
                            value={noticeDetailsFields.notice_num || ''}
                            onChange={(e) => updateNoticeDetailsField('notice_num', e.target.value)}
                            placeholder="Í≥µÍ≥†Î≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            className="flex-1" style={{color: 'var(--color-primary-foreground)'}}
                          />
                        ) : (
                          <span className="flex-1" style={{color: 'var(--color-primary-foreground)'}}>{noticeDetailsFields.notice_num || '-'}</span>
                        )}
                      </div>

                      {/* Îã¥ÎãπÎ∂ÄÏÑú, Îã¥ÎãπÏ†ÑÌôî */}
                      <div className="flex items-center">
                        <span className="text-sm w-20 flex-shrink-0 text-gray-500">Îã¥ÎãπÎ∂ÄÏÑú</span>
                        {isEditingNoticeDetails ? (
                          <Input
                            value={noticeDetailsFields.org_dept || ''}
                            onChange={(e) => updateNoticeDetailsField('org_dept', e.target.value)}
                            placeholder="Îã¥ÎãπÎ∂ÄÏÑúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            className="w-40 mr-4" style={{color: 'var(--color-primary-foreground)'}}
                          />
                        ) : (
                          <span className="w-40 mr-4" style={{color: 'var(--color-primary-foreground)'}}>{noticeDetailsFields.org_dept || bid.orgName || '-'}</span>
                        )}
                        <span className="text-sm w-20 flex-shrink-0 text-gray-500">Îã¥ÎãπÏ†ÑÌôî</span>
                        {isEditingNoticeDetails ? (
                          <Input
                            value={noticeDetailsFields.org_tel || ''}
                            onChange={(e) => updateNoticeDetailsField('org_tel', e.target.value)}
                            placeholder="Îã¥ÎãπÏ†ÑÌôîÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            className="w-40" style={{color: 'var(--color-primary-foreground)'}}
                          />
                        ) : (
                          <span className="w-40" style={{color: 'var(--color-primary-foreground)'}}>{noticeDetailsFields.org_tel || '-'}</span>
                        )}
                      </div>

                      {/* ÏóÖÎ¨¥Íµ¨Î∂Ñ, ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ */}
                      <div className="flex items-center">
                        <span className="text-sm w-20 flex-shrink-0 text-gray-500">ÏóÖÎ¨¥Íµ¨Î∂Ñ</span>
                        {isEditingNoticeDetails ? (
                          <Input
                            value={noticeDetailsFields.category || ''}
                            onChange={(e) => updateNoticeDetailsField('category', e.target.value)}
                            placeholder="ÏóÖÎ¨¥Íµ¨Î∂ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            className="w-40 mr-4" style={{color: 'var(--color-primary-foreground)'}}
                          />
                        ) : (
                          <span className="w-40 mr-4" style={{color: 'var(--color-primary-foreground)'}}>{noticeDetailsFields.category || bid.category || '-'}</span>
                        )}
                        <span className="text-sm w-20 flex-shrink-0 text-gray-500">ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ</span>
                        {isEditingNoticeDetails ? (
                          <Input
                            value={noticeDetailsFields.detail_url || ''}
                            onChange={(e) => updateNoticeDetailsField('detail_url', e.target.value)}
                            placeholder="ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            className="w-40" style={{color: 'var(--color-primary-foreground)'}}
                          />
                        ) : (
                          <div className="w-40">
                            {noticeDetailsFields.detail_url ? (
                              <a
                                href={noticeDetailsFields.detail_url}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-blue-600 hover:text-blue-800 hover:underline"
                                style={{color: 'var(--color-primary-foreground)'}}
                              >
                                ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÎßÅÌÅ¨
                              </a>
                            ) : (
                              <span style={{color: 'var(--color-primary-foreground)'}}>-</span>
                            )}
                          </div>
                        )}
                      </div>

                      {/* Í≥µÍ≥†Î≥∏Î¨∏ */}
                      {(noticeDetailsFields.body_html || isEditingNoticeDetails) && (
                        <div className="flex items-start">
                          <span className="text-sm w-20 flex-shrink-0 mt-2 text-gray-500">Í≥µÍ≥†Î≥∏Î¨∏</span>
                          {isEditingNoticeDetails ? (
                            <Textarea
                              value={noticeDetailsFields.body_html || ''}
                              onChange={(e) => updateNoticeDetailsField('body_html', e.target.value)}
                              placeholder="Í≥µÍ≥†Î≥∏Î¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                              rows={4}
                              className="flex-1" style={{color: 'var(--color-primary-foreground)'}}
                            />
                          ) : (
                            <div className="flex-1 max-h-32 overflow-y-auto text-sm p-3 border rounded" style={{color: 'var(--color-primary-foreground)'}}>
                              {noticeDetailsFields.body_html ? (
                                <div dangerouslySetInnerHTML={{ __html: noticeDetailsFields.body_html }} />
                              ) : (
                                <span>-</span>
                              )}
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                  <div className="flex justify-end gap-2 mt-6 pt-4 border-t">
                    {isEditingNoticeDetails ? (
                      <>
                        <ButtonWithColorIcon
                          icon={<span className="mr-2"><Edit3 className="h-4 w-4" /></span>}
                          color="tertiary"
                          mode="filled"
                          onClick={() => {
                            setIsEditingNoticeDetails(false);
                            // ÏõêÎûò Îç∞Ïù¥ÌÑ∞Î°ú Î≥µÏõê
                            if (noticeDetailsData?.noticeDetails?.details) {
                              setNoticeDetailsFields(noticeDetailsData.noticeDetails.details);
                            }
                          }}
                        >
                          Ï∑®ÏÜå
                        </ButtonWithColorIcon>
                        <ButtonWithColorIcon
                          icon={<span className="mr-2"><CheckSquare className="h-4 w-4" /></span>}
                          color="secondary"
                          mode="active"
                          onClick={saveNoticeDetailsFields}
                          disabled={updatingDetails}
                        >
                          Ï†ÄÏû•
                        </ButtonWithColorIcon>
                      </>
                    ) : (
                      <ButtonWithIcon
                        icon={<span className="mr-2"><Edit3 className="h-4 w-4" /></span>}
                        onClick={() => setIsEditingNoticeDetails(true)}
                      >
                        Ìé∏Ïßë
                      </ButtonWithIcon>
                    )}
                  </div>
                </TabContainer>
              </div>
            )}

            {/* ÏûÖÏ∞∞ ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÌÉ≠ */}
            {infoActiveTab === 'bid' && (
              <div>
                <TabContainer>
                  <div className="space-y-3">
                    {(() => {
                      const fields = Object.entries(noticeFields);
                      const rows: React.ReactElement[] = [];

                      // 2Í∞úÏî© Í∑∏Î£πÌôî
                      for (let i = 0; i < fields.length; i += 2) {
                        const field1 = fields[i];
                        const field2 = fields[i + 1];

                        rows.push(
                          <div key={`row-${i}`} className="flex items-center">
                            {/* Ï≤´ Î≤àÏß∏ ÌïÑÎìú */}
                            <span className="text-sm flex-shrink-0 text-gray-500" style={{width: '100px', minWidth: '100px'}}>{field1[0]}</span>
                            {isEditingNotice ? (
                              <Input
                                value={noticeFields[field1[0]] || ''}
                                onChange={(e) => updateNoticeField(field1[0], e.target.value)}
                                placeholder={`${field1[0]}ÏùÑ(Î•º) ÏûÖÎ†•ÌïòÏÑ∏Ïöî`}
                                className="w-40 mr-4" style={{color: 'var(--color-primary-foreground)'}}
                              />
                            ) : (
                              <span className="w-40 mr-4" style={{color: 'var(--color-primary-foreground)'}}>{field1[1] || 'Ï†ïÎ≥¥ ÏóÜÏùå'}</span>
                            )}

                            {/* Îëê Î≤àÏß∏ ÌïÑÎìú (ÏûàÎäî Í≤ΩÏö∞Îßå) */}
                            {field2 && (
                              <>
                                <span className="text-sm flex-shrink-0 text-gray-500" style={{width: '100px', minWidth: '100px'}}>{field2[0]}</span>
                                {isEditingNotice ? (
                                  <Input
                                    value={noticeFields[field2[0]] || ''}
                                    onChange={(e) => updateNoticeField(field2[0], e.target.value)}
                                    placeholder={`${field2[0]}ÏùÑ(Î•º) ÏûÖÎ†•ÌïòÏÑ∏Ïöî`}
                                    className="w-40" style={{color: 'var(--color-primary-foreground)'}}
                                  />
                                ) : (
                                  <span className="w-40" style={{color: 'var(--color-primary-foreground)'}}>{field2[1] || 'Ï†ïÎ≥¥ ÏóÜÏùå'}</span>
                                )}
                              </>
                            )}
                          </div>
                        );
                      }

                      return rows;
                    })()}
                  </div>
                  
                  {/* Î©îÎ™® ÌïÑÎìú */}
                  <div className="border-t pt-4 mt-4">
                    <div className="flex items-start">
                      <span className="text-sm flex-shrink-0 mt-2 text-gray-500" style={{width: '100px', minWidth: '100px'}}>Î©îÎ™®</span>
                      {isEditingNotice ? (
                        <Textarea
                          value={progressMemo}
                          onChange={(e) => setProgressMemo(e.target.value)}
                          placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                          rows={3}
                          className="flex-1" style={{color: 'var(--color-primary-foreground)'}}
                        />
                      ) : (
                        <div className="flex-1 p-3 border rounded min-h-[80px]" style={{color: 'var(--color-primary-foreground)'}}>
                          {progressMemo || 'Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.'}
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="flex justify-end gap-2 mt-6 pt-4 border-t">
                    {isEditingNotice ? (
                      <>
                        <ButtonWithColorIcon
                          icon={<span className="mr-2"><Edit3 className="h-4 w-4" /></span>}
                          color="tertiary"
                          mode="filled"
                          onClick={() => {
                            setIsEditingNotice(false);
                            // ÏõêÎûò Îç∞Ïù¥ÌÑ∞Î°ú Î≥µÏõê
                            const bidDetail = detailData['ÏûÖÏ∞∞'] || {};
                            setNoticeFields(bidDetail);
                            setProgressMemo(extractProgressMemo());
                          }}
                        >
                          Ï∑®ÏÜå
                        </ButtonWithColorIcon>
                        <ButtonWithColorIcon
                          icon={<span className="mr-2"><CheckSquare className="h-4 w-4" /></span>}
                          color="secondary"
                          mode="active"
                          onClick={saveNoticeFields}
                          disabled={loading}
                        >
                          Ï†ÄÏû•
                        </ButtonWithColorIcon>
                      </>
                    ) : (
                      <ButtonWithIcon
                        icon={<span className="mr-2"><Edit3 className="h-4 w-4" /></span>}
                        onClick={() => setIsEditingNotice(true)}
                      >
                        Ìé∏Ïßë
                      </ButtonWithIcon>
                    )}
                  </div>
                </TabContainer>
              </div>
            )}
          </div>
        )}
      </div>

      {/* ÏûÖÏ∞∞ Î¨∏ÏÑú */}
      <SectionWithGuide
        title="ÏûÖÏ∞∞ Î¨∏ÏÑú"
        icon={<FileText className="w-5 h-5" />}
        accentColor="#10b981"
        category="Ïö¥ÏòÅÍ∞ÄÏù¥Îìú"
        pageTitle={pageTitle}
        isExpanded={isDocumentExpanded}
        onToggle={setIsDocumentExpanded}
      >
        <TabHeader
          tabs={[
            {
              id: 'files',
              label: 'Í≥µÍ≥† Î¨∏ÏÑú',
              icon: <FileText className="w-4 h-4" />
            },
            {
              id: 'write',
              label: 'Î¨∏ÏÑú ÏûëÏÑ±',
              icon: <Edit3 className="w-4 h-4" />
            }
          ]}
          activeTab={documentActiveTab}
          onTabChange={setDocumentActiveTab}
        />
            
            {/* Í≥µÍ≥† Î¨∏ÏÑú ÌÉ≠ */}
            {documentActiveTab === 'files' && (
              <TabContainer>
              {filesLoading ? (
                <div className="flex items-center justify-center py-8">
                  <Loader2 className="w-6 h-6 animate-spin" />
                  <span className="ml-2">ÌååÏùº Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
                </div>
              ) : noticeFilesData?.noticeFiles?.files?.length > 0 ? (
                <>
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead className="text-center w-20">ÏàúÎ≤à</TableHead>
                        <TableHead>ÌååÏùº</TableHead>
                        <TableHead className="text-center w-24">Îã§Ïö¥Î°úÎìú</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {noticeFilesData.noticeFiles.files.map((file: any, index: number) => (
                        <TableRow key={index}>
                          <TableCell className="text-center font-medium">
                            {file.order || '-'}
                          </TableCell>
                          <TableCell>
                            <div className="flex items-center gap-2">
                              <FileText className="w-4 h-4 text-color-primary-muted-foreground" />
                              {isEditingFiles ? (
                                <Input
                                  value={file.file_name}
                                  onChange={(e) => {
                                    // TODO: ÌååÏùºÎ™Ö Ìé∏Ïßë Í∏∞Îä• Íµ¨ÌòÑ
                                  }}
                                  className="flex-1"
                                />
                              ) : (
                                <div className="flex-1">
                                  <button
                                    className="text-left text-blue-600 hover:text-blue-800 hover:underline focus:outline-none"
                                    onClick={() => openFileViewer(file.file_name, file.file_url)}
                                    title="ÌÅ¥Î¶≠ÌïòÏó¨ ÌååÏùº Î∑∞Ïñ¥ Ïó¥Í∏∞"
                                  >
                                    {file.file_name}
                                  </button>
                                </div>
                              )}
                            </div>
                          </TableCell>
                          <TableCell className="text-center">
                            <Checkbox
                              checked={selectedDownloads.has(file.file_name)}
                              onCheckedChange={(checked) => {
                                const newSet = new Set(selectedDownloads);
                                if (checked) {
                                  newSet.add(file.file_name);
                                } else {
                                  newSet.delete(file.file_name);
                                }
                                setSelectedDownloads(newSet);
                              }}
                            />
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                  <div className="pt-2 border-t space-y-3">
                    <div className="text-sm text-color-primary-muted-foreground">
                      Ï¥ù {noticeFilesData.noticeFiles.total_count}Í∞ú ÌååÏùº ‚Ä¢ ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: {bid.postedAt?.split('T')[0]}
                    </div>
                    
                    {/* NAS Í≤ΩÎ°ú ÌëúÏãú */}
                    {(() => {
                      const nasPath = noticeFilesData.noticeFiles.files.find((f: any) => f.down_folder)?.down_folder;
                      return nasPath ? (
                        <div className="p-3 rounded-lg">
                          <div className="text-sm font-medium text-color-primary-foreground mb-1">NAS Í≤ΩÎ°ú (Î°úÏª¨ Í≤ΩÎ°ú)</div>
                          <div className="text-sm text-color-primary-muted-foreground font-mono break-all">{nasPath}</div>
                        </div>
                      ) : null;
                    })()}
                    
                    <div className="flex justify-end">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          // TODO: NAS ÌååÏùº Î∏åÎùºÏö∞Ï†Ä Íµ¨ÌòÑ
                          const nasPath = noticeFilesData.noticeFiles.files.find((f: any) => f.down_folder)?.down_folder;
                          if (nasPath) {
                            alert(`NAS ÌååÏùº Î∏åÎùºÏö∞Ï†Ä Íµ¨ÌòÑ ÏòàÏ†ï\nÍ≤ΩÎ°ú: ${nasPath}`);
                          } else {
                            alert('Î°úÏª¨ ÌååÏùº Í≤ΩÎ°úÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                          }
                        }}
                      >
                        <FileText className="w-4 h-4 mr-1" />
                        NAS ÌååÏùº Î≥¥Í∏∞
                      </Button>
                    </div>
                  </div>
                  {selectedDownloads.size > 0 && (
                    <div className="flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                      <span className="text-sm text-blue-700 dark:text-blue-400">
                        {selectedDownloads.size}Í∞ú ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìú ÎåÄÏÉÅÏúºÎ°ú ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.
                      </span>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          // TODO: ÏÑ†ÌÉùÎêú ÌååÏùºÎì§ Îã§Ïö¥Î°úÎìú Í∏∞Îä• Íµ¨ÌòÑ
                          alert('ÏÑ†ÌÉùÎêú ÌååÏùº Îã§Ïö¥Î°úÎìú Í∏∞Îä• Íµ¨ÌòÑ ÏòàÏ†ï');
                        }}
                      >
                        ÏÑ†ÌÉù Îã§Ïö¥Î°úÎìú
                      </Button>
                    </div>
                  )}
                </>
              ) : (
                <div className="text-center py-8 text-color-primary-muted-foreground">
                  Í≥µÍ≥† Î¨∏ÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
              )}
                  <div className="flex justify-end gap-2 mt-6 pt-4 border-t">
                    <ButtonWithIcon
                      icon={<span className="mr-2">{isEditingFiles ? <CheckSquare className="h-4 w-4" /> : <Edit3 className="h-4 w-4" />}</span>}
                      onClick={() => {
                        if (isEditingFiles) {
                          saveFilesData();
                        } else {
                          setIsEditingFiles(!isEditingFiles);
                        }
                      }}
                    >
                      {isEditingFiles ? "Ï†ÄÏû•" : "Ìé∏Ïßë"}
                    </ButtonWithIcon>
                    <ButtonWithIcon
                      icon={<span className="mr-2"><Plus className="h-4 w-4" /></span>}
                      onClick={() => {
                        // TODO: Ï∂îÍ∞Ä Í∏∞Îä• Íµ¨ÌòÑ
                        alert('ÌååÏùº Ï∂îÍ∞Ä Í∏∞Îä• Íµ¨ÌòÑ ÏòàÏ†ï');
                      }}
                    >
                      Ï∂îÍ∞Ä
                    </ButtonWithIcon>
                    <ButtonWithIcon
                      icon={<span className="mr-2"><Download className="h-4 w-4" /></span>}
                      onClick={() => {
                        // TODO: ÏÑ†ÌÉùÎêú ÌååÏùºÎì§ Îã§Ïö¥Î°úÎìú Í∏∞Îä• Íµ¨ÌòÑ
                        if (selectedDownloads.size > 0) {
                          alert(`${selectedDownloads.size}Í∞ú ÌååÏùº Îã§Ïö¥Î°úÎìú Í∏∞Îä• Íµ¨ÌòÑ ÏòàÏ†ï`);
                        } else {
                          alert('Îã§Ïö¥Î°úÎìúÌï† ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                        }
                      }}
                      disabled={selectedDownloads.size === 0}
                    >
                      Îã§Ïö¥
                    </ButtonWithIcon>
                  </div>
              </TabContainer>
            )}

            {/* Î¨∏ÏÑú ÏûëÏÑ± ÌÉ≠ */}
            {documentActiveTab === 'write' && (
              <TabContainer>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Button variant="outline" className="h-20 flex flex-col gap-2">
                  <FileText className="w-6 h-6" />
                  <span>ÏûÖÏ∞∞ÏÑú ÏûëÏÑ±</span>
                </Button>
                <Button variant="outline" className="h-20 flex flex-col gap-2">
                  <Edit3 className="w-6 h-6" />
                  <span>ÏÇ¨ÏóÖÍ≥ÑÌöçÏÑú ÏûëÏÑ±</span>
                </Button>
                <Button variant="outline" className="h-20 flex flex-col gap-2">
                  <FileText className="w-6 h-6" />
                  <span>Í∏∞Ïà†Ï†úÏïàÏÑú ÏûëÏÑ±</span>
                </Button>
                <Button variant="outline" className="h-20 flex flex-col gap-2">
                  <Edit3 className="w-6 h-6" />
                  <span>ÌååÏùº ÏóÖÎ°úÎìú</span>
                </Button>
              </div>
              <div className="text-sm text-color-primary-muted-foreground">
                ÏûÖÏ∞∞ ÎßàÍ∞êÏùºÍπåÏßÄ Î™®Îì† ÌïÑÏàò ÏÑúÎ•òÎ•º Ï†úÏ∂úÌï¥Ïïº Ìï©ÎãàÎã§.
              </div>
              </TabContainer>
            )}
      </SectionWithGuide>

      {/* Îã®Í≥Ñ Î≥ÄÍ≤Ω */}
      <div>
        <div className="flex items-center gap-2">
          <DropdownSectionHeader
            title="Îã®Í≥Ñ Î≥ÄÍ≤Ω"
            icon={<RefreshCw className="w-5 h-5" />}
            isExpanded={isStageExpanded}
            onToggle={() => setIsStageExpanded(!isStageExpanded)}
            accentColor="#f59e0b"
          />
          <SectionTitleHelp
            isOpen={isStageGuideOpen}
            onToggle={() => setIsStageGuideOpen(!isStageGuideOpen)}
          />
        </div>

        {/* Îã®Í≥Ñ Î≥ÄÍ≤Ω ÏóÖÎ¨¥ Í∞ÄÏù¥Îìú */}
        {isStageGuideOpen && (
          <div className="mt-2 bg-orange-50 border border-orange-200 p-4 rounded-lg">
            <div className="max-w-full">
              <h4 className="font-semibold text-orange-800 mb-2">Îã®Í≥Ñ Î≥ÄÍ≤Ω ÏóÖÎ¨¥ Í∞ÄÏù¥Îìú</h4>
              <div className="text-sm text-orange-700 space-y-2">
                <p>‚Ä¢ ÏùëÏ∞∞: ÏûÖÏ∞∞ Ï∞∏Ïó¨ Îã®Í≥ÑÎ°ú, ÌïÑÏöîÌïú ÏÑúÎ•òÎ•º Ï§ÄÎπÑÌïòÍ≥† Ï†úÏ∂úÌï©ÎãàÎã§.</p>
                <p>‚Ä¢ Ìè¨Í∏∞: Îã§ÏñëÌïú ÏÇ¨Ïú†Î°ú ÏûÖÏ∞∞ÏùÑ Ìè¨Í∏∞ÌïòÎäî Í≤ΩÏö∞ ÏÑ†ÌÉùÌï©ÎãàÎã§.</p>
                <p>‚Ä¢ Îã®Í≥Ñ Î≥ÄÍ≤Ω Ïãú Î©îÎ™®Î•º ÏûëÏÑ±ÌïòÏó¨ Î≥ÄÍ≤Ω ÏÇ¨Ïú†Î•º Í∏∞Î°ùÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
              </div>
            </div>
          </div>
        )}

        {isStageExpanded && (
          <div className="mt-2 space-y-0">
            {/* ÌÉ≠ Î≤ÑÌäº */}
            <div className="flex border-b justify-between">
              <div className="flex">
                <button
                  className={`tab-button px-4 py-2 font-medium text-sm flex items-center gap-2 ${
                    stageActiveTab === 'ÏùëÏ∞∞'
                      ? 'active'
                      : 'text-color-primary-muted-foreground'
                  }`}
                  onClick={() => {
                    setStageActiveTab('ÏùëÏ∞∞');
                    setSelectedStatus('ÏùëÏ∞∞');
                    loadStatusData('ÏùëÏ∞∞');
                  }}
                >
                  <CheckSquare className="w-4 h-4" />
                  ÏùëÏ∞∞
                </button>
                <button
                  className={`tab-button px-4 py-2 font-medium text-sm flex items-center gap-2 ${
                    stageActiveTab === 'Ìè¨Í∏∞'
                      ? 'active'
                      : 'text-color-primary-muted-foreground'
                  }`}
                  onClick={() => {
                    setStageActiveTab('Ìè¨Í∏∞');
                    setSelectedStatus('Ìè¨Í∏∞');
                    loadStatusData('Ìè¨Í∏∞');
                  }}
                >
                  <X className="w-4 h-4" />
                  Ìè¨Í∏∞
                </button>
              </div>
              <div className="flex">
                <button
                  className="tab-button px-4 py-2 font-medium text-sm flex items-center gap-2 text-color-primary-muted-foreground cursor-not-allowed opacity-50"
                  disabled
                >
                  <Trophy className="w-4 h-4" />
                  ÎÇôÏ∞∞
                </button>
                <button
                  className="tab-button px-4 py-2 font-medium text-sm flex items-center gap-2 text-color-primary-muted-foreground cursor-not-allowed opacity-50"
                  disabled
                >
                  <XCircle className="w-4 h-4" />
                  Ìå®Ï∞∞
                </button>
              </div>
            </div>

            <div className="border rounded-lg p-4 space-y-4" style={{borderColor: 'var(--color-primary-foreground)'}}>
              {renderDynamicFields()}

              {selectedStatus && (
                <div className="flex justify-end pt-4 border-t">
                  <ButtonWithIcon
                    icon={<span className="mr-2"><ArrowRight className="h-4 w-4" /></span>}
                    onClick={handleStatusChange}
                    disabled={loading}
                  >
                    {loading ? (
                      <>
                        <Loader2 className="h-4 w-4 animate-spin mr-2" />
                        Ï≤òÎ¶¨ Ï§ë...
                      </>
                    ) : (
                      'Îã®Í≥Ñ Î≥ÄÍ≤Ω'
                    )}
                  </ButtonWithIcon>
                </div>
              )}
            </div>
          </div>
        )}

      </div>

    </div>
  );
}